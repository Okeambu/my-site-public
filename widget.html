<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Виджет Радио</title>
<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: transparent !important;
    box-sizing: border-box;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  *, *::before, *::after {
    box-sizing: inherit;
  }
  button, input, select, textarea {
    -webkit-appearance: none;
    appearance: none;
    border-radius: 0;
    font-family: inherit;
    font-size: inherit;
    background: none;
    border: none;
    outline: none;
    padding: 0;
    margin: 0;
  }
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    background: none;
    border: none;
    outline: none;
  }

  .square-outer {
    max-width: 320px;
    width: 100%;
    height: 320px;
    margin: 0 auto;
    position: relative;
  }
  .square-inner {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100%; height: 100%;
    border-radius: 24px;
    overflow: hidden;
    background: #222;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #widget-container {
    width: 100%; height: 100%;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    font-family: sans-serif;
    color: white;
  }
  #widget-container img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 12px;
    display: block;
  }

  /* Бегущая строка */
  #track-title {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 24px;
    overflow: hidden;
    padding: 0 8px;
    z-index: 10;
    background: transparent;
    pointer-events: none;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.8);
    font-weight: 400;
    white-space: nowrap;
    user-select: none;
    font-family: sans-serif;
    visibility: hidden; /* по умолчанию скрыта */
  }
  #marquee-inner {
    position: relative;
    height: 24px;
  }
  .marquee-item {
    position: absolute;
    top: 0;
    white-space: nowrap;
    padding-right: 4em;
    will-change: transform;
  }

  .player-overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
  }
  .btn-playpause {
    pointer-events: auto;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-53%, -56%);
    background: transparent;
    border: none;
    color: #ff0000;
    cursor: pointer;
    user-select: none;
    padding: 0;
    line-height: 1;
    z-index: 2;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .btn-playpause:active {
    background: rgba(255,0,0,0.07);
  }
  .icon-play svg {
    width: 68px;
    height: 68px;
  }
  .icon-pause svg {
    width: 72px;
    height: 72px;
    transform: translate(2px, 1px);
  }
  .volume-wrapper {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    pointer-events: auto;
    z-index: 1;
    width: 80%;
    max-width: 280px;
  }
  .volume-label {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 4px;
    user-select: none;
  }
  .volume-slider {
    pointer-events: auto;
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: transparent;
  }
  .volume-slider::-webkit-slider-runnable-track {
    height: 6px;
    background: #444;
    border-radius: 3px;
  }
  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: red;
    margin-top: -6px;
    cursor: pointer;
  }
  .volume-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: red;
    cursor: pointer;
  }

  @keyframes flash {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.8); }
    100% { filter: brightness(1); }
  }
  .flash-effect {
    animation: flash 0.4s ease;
  }
</style>
</head>
<body>
  <div class="square-outer">
    <div class="square-inner">
      <div id="widget-container">
        <img src="images/Testpic.jpeg" alt="widget radio" />
        <div id="track-title" aria-live="off" aria-atomic="true">
          <div id="marquee-inner"></div>
        </div>
        <div class="player-overlay">
          <button class="btn-playpause" id="playpause-btn" aria-label="Play/Pause">
            <span class="icon-play">
              <svg viewBox="0 0 88 88" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M32 22C32 20.9 33.1 20.2 34.1 20.7L72.1 43.7C73.1 44.3 73.1 45.7 72.1 46.3L34.1 69.3C33.1 69.8 32 69.1 32 68V22Z" fill="#ff0000"/>
              </svg>
            </span>
          </button>
          <div class="volume-wrapper">
            <div class="volume-label">Volume</div>
            <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.01" value="0.5" />
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const playlist = [
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/ionos%20glaze-0481F_master%202.mp3', title: 'Ionos Glaze' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/mr_cobalt_master_.mp3', title: 'Cobalt Luna' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/miniature11.mp3', title: 'Stellar Flowers' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/STINGERSSOUND-type2-7.mp3', title: 'Order exclusive sound for your business!' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/tranza.mp3', title: 'Tranza' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/switch%20of%20gravity%20(fragment).mp3', title: 'Switch Off Gravity (fragment)' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/STINGERSSOUND4.mp3', title: 'Order exclusive sound for your business!' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/love%20sketches%20in%20pink%20mist.mp3', title: 'Love Glow Sketches In Pink Mist' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/Golden%20Mountain.mp3', title: 'Golden Mountain' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/STINGERSSOUND-type2-7.mp3', title: 'Order exclusive sound for your business!' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/gills%20forever_fragment1.mp3', title: 'Gills Forever (fragment)' },

{ src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music1/Beyond%20the%20Space%20Membranes.mp3', title: 'Beyond the Space Membranes' },
    


    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/Troposcapes%20of%20Umbriel3.mp3', title: 'Troposcapes of Umbriel-3' },
    { src: 'https://cdn.jsdelivr.net/gh/Okeambu/sss-promo-audio/music/ok2.mp3', title: 'Blue Sun' }
  ];

 

  const playBtn = document.getElementById('playpause-btn');
  const volumeSlider = document.getElementById('volume-slider');
  const marqueeInner = document.getElementById('marquee-inner');
  const trackTitleContainer = document.getElementById('track-title');
  const img = document.querySelector('#widget-container img');

  let isPlaying = false;

  // Создаём AudioContext и GainNode один раз
  let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let gainNode = audioCtx.createGain();
  gainNode.gain.value = parseFloat(volumeSlider.value);
  gainNode.connect(audioCtx.destination);

  let currentAudio = null;
  let currentSource = null;

  const speed = 100; // px/s
  const gap = 150; // px между экземплярами
  let items = [];
  let lastRightEdge = 0;
  let currentText = '';

  let currentIndex = 0; // индекс текущего трека

  function clearMarquee() {
    items.forEach(item => {
      if (item.el.parentNode) item.el.parentNode.removeChild(item.el);
    });
    items = [];
    lastRightEdge = 0;
    trackTitleContainer.style.visibility = 'hidden';
  }

  function addMarqueeItem(text) {
    const span = document.createElement('span');
    span.className = 'marquee-item';
    span.textContent = text;
    marqueeInner.appendChild(span);
    const left = lastRightEdge + gap;
    span.style.left = left + 'px';
    items.push({el: span, left: left});
    lastRightEdge = left + span.offsetWidth;
  }

  function animateMarquee(timestamp) {
    if (!animateMarquee.lastTimestamp) animateMarquee.lastTimestamp = timestamp;
    const delta = (timestamp - animateMarquee.lastTimestamp) / 1000;
    animateMarquee.lastTimestamp = timestamp;

    for(let i = items.length - 1; i >= 0; i--) {
      items[i].left -= speed * delta;
      items[i].el.style.left = items[i].left + 'px';

      if(items[i].left + items[i].el.offsetWidth < 0) {
        marqueeInner.removeChild(items[i].el);
        items.splice(i, 1);
      }
    }

    if (items.length > 0) {
      lastRightEdge = items.reduce((max, item) => Math.max(max, item.left + item.el.offsetWidth), 0);
    } else {
      lastRightEdge = 0;
    }

    const containerWidth = marqueeInner.offsetWidth || window.innerWidth;
    if (lastRightEdge < containerWidth + gap) {
      addMarqueeItem(currentText);
    }

    requestAnimationFrame(animateMarquee);
  }

  function setPlayButtonIcon(playing) {
    playBtn.innerHTML = playing
      ? `<span class="icon-pause"><svg width="72" height="72" viewBox="0 0 72 72"><rect x="24" y="18" width="10" height="36" rx="5" fill="#ff0000"/><rect x="38" y="18" width="10" height="36" rx="5" fill="#ff0000"/></svg></span>`
      : `<span class="icon-play"><svg width="88" height="88" viewBox="0 0 88 88"><path d="M32 22C32 20.9 33.1 20.2 34.1 20.7L72.1 43.7C73.1 44.3 73.1 45.7 72.1 46.3L34.1 69.3C33.1 69.8 32 69.1 32 68V22Z" fill="#ff0000"/></svg></span>`;
  }

  function stopCurrentTrack() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.src = '';
      currentAudio = null;
    }
    if (currentSource) {
      try { currentSource.disconnect(); } catch(e) {}
      currentSource = null;
    }
    // Не закрываем audioCtx, он создаётся один раз и живёт всё время
    setPlayButtonIcon(false);
    isPlaying = false;

    clearMarquee();
  }

  function playTrack(index) {
    stopCurrentTrack();

    const track = playlist[index];
    const audio = new Audio(track.src);
    audio.crossOrigin = "anonymous";
    audio.preload = "auto";

    const source = audioCtx.createMediaElementSource(audio);
    source.connect(gainNode);

    currentAudio = audio;
    currentSource = source;

    currentIndex = index;
    currentText = track.title;

    clearMarquee();
    trackTitleContainer.style.visibility = 'visible';
    lastRightEdge = 0;
    addMarqueeItem(currentText);
    requestAnimationFrame(animateMarquee);

    // Разблокируем AudioContext, если он в состоянии suspended
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }

    audio.play().then(() => {
      img.classList.add('flash-effect');
      setTimeout(() => img.classList.remove('flash-effect'), 400);
      setPlayButtonIcon(true);
      isPlaying = true;
    }).catch(e => {
      console.warn("Ошибка воспроизведения:", e);
      setPlayButtonIcon(false);
      isPlaying = false;
      clearMarquee();
    });

    audio.addEventListener('ended', () => {
      const nextIndex = (currentIndex + 1) % playlist.length;
      playTrack(nextIndex);
    });
  }

  playBtn.addEventListener('click', () => {
    if (!isPlaying) {
      const startIndex = Math.floor(Math.random() * playlist.length);
      playTrack(startIndex);
    } else {
      stopCurrentTrack();
    }
  });

  volumeSlider.addEventListener('input', () => {
    if (gainNode) gainNode.gain.value = parseFloat(volumeSlider.value);
  });

  // Инициализация
  setPlayButtonIcon(false);
  clearMarquee();
  currentText = playlist[0].title;
</script>
</body>
</html>
